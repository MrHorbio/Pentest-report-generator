from flask import Flask, render_template, request, redirect, url_for, send_from_directory
import os
from datetime import datetime

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = 'static/reports'  # Use static/reports for storing images
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16 MB limit

@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        title = request.form.get('title')
        description = request.form.get('description')
        summary = request.form.get('summary')
        steps = request.form.get('steps')
        impact = request.form.get('impact')
        remediation = request.form.get('remediation')
        screenshot = request.files.get('screenshot')

        # Save the screenshot
        screenshot_filename = None
        if screenshot:
            screenshot_filename = f"screenshot_{datetime.now().strftime('%Y%m%d_%H%M%S')}.png"
            screenshot.save(os.path.join(app.config['UPLOAD_FOLDER'], screenshot_filename))

        # Generate report
        report_filename = f"report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.html"
        report_path = os.path.join(app.config['UPLOAD_FOLDER'], report_filename)
        with open(report_path, 'w') as f:
            f.write(render_template('report_template.html',
                                   title=title,
                                   description=description,
                                   summary=summary,
                                   steps=steps,
                                   impact=impact,
                                   remediation=remediation,
                                   screenshot_filename=screenshot_filename))

        return redirect(url_for('download_report', filename=report_filename))

    return render_template('index.html')

@app.route('/static/reports/<filename>')
def download_report(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

if __name__ == '__main__':
    os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
    app.run(debug=True)
